<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI工具</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    #app {
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    #app-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 32px;
      background-color: white;
      user-select: none;
      -webkit-app-region: drag;
    }

    #app-title {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      text-align: center;
      line-height: 32px;
    }

    #app-operator {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      display: flex;
      -webkit-app-region: no-drag;
    }

    #app-top, #app-close {
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: none;
      cursor: pointer;
      width: 32px;
      height: 32px;
    }

    #app-top:hover, #app-close:hover {
      background-color: #f5f5f5;
    }

    #app-close:hover {
      background-color: #ff4d4f;
    }

    .icon {
      width: 16px;
      height: 16px;
    }

    #app-container {
      position: absolute;
      top: 32px;
      left: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
    }

    .spinner-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .tool-iframe {
      width: 100%;
      height: 100%;
      border: none;
      margin: 0;
      padding: 0;
    }

    .spinner {
      width: 70.4px;
      height: 70.4px;
      --clr: rgb(247, 197, 159);
      --clr-alpha: rgb(247, 197, 159, .1);
      animation: spinner 1.6s infinite ease;
      transform-style: preserve-3d;
    }

    .spinner > div {
      background-color: var(--clr-alpha);
      height: 100%;
      position: absolute;
      width: 100%;
      border: 3.5px solid var(--clr);
    }

    .spinner div:nth-of-type(1) {
      transform: translateZ(-35.2px) rotateY(180deg);
    }

    .spinner div:nth-of-type(2) {
      transform: rotateY(-270deg) translateX(50%);
      transform-origin: top right;
    }

    .spinner div:nth-of-type(3) {
      transform: rotateY(270deg) translateX(-50%);
      transform-origin: center left;
    }

    .spinner div:nth-of-type(4) {
      transform: rotateX(90deg) translateY(-50%);
      transform-origin: top center;
    }

    .spinner div:nth-of-type(5) {
      transform: rotateX(-90deg) translateY(50%);
      transform-origin: bottom center;
    }

    .spinner div:nth-of-type(6) {
      transform: translateZ(35.2px);
    }

    @keyframes spinner {
      0% {
        transform: rotate(45deg) rotateX(-25deg) rotateY(25deg);
      }

      50% {
        transform: rotate(45deg) rotateX(-385deg) rotateY(25deg);
      }

      100% {
        transform: rotate(45deg) rotateX(-385deg) rotateY(385deg);
      }
    }

    /* 错误显示样式 */
    .error-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      padding: 20px;
      box-sizing: border-box;
    }

    .error-title {
      color: #ff0000;
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }

    .error-message {
      color: #ff0000;
      font-size: 16px;
      margin-bottom: 20px;
      text-align: center;
      max-width: 80%;
      word-wrap: break-word;
    }

    .error-stack {
      color: #ff0000;
      font-size: 14px;
      background-color: #ffe6e6;
      border: 1px solid #ff0000;
      border-radius: 4px;
      padding: 15px;
      width: 80%;
      max-height: 50%;
      overflow: auto;
      white-space: pre-wrap;
      text-align: left;
    }
  </style>
</head>
<body>
<div id="app">
  <div id="app-header">
    <div id="app-title">AI工具箱</div>
    <div id="app-operator">
      <button id="app-top">
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6241" xmlns:xlink="http://www.w3.org/1999/xlink">
          <path d="M393.846154 64.174932l117.454119 0.399843H512.499805l117.454119-0.399843-10.395939 10.395939c-18.89262 18.89262-28.488872 44.982429-26.28973 71.472081l20.292073 250.502148c2.998829 36.68567 18.092932 72.171808 42.483405 99.661069l34.186646 38.684889-122.252245-0.899648-55.478329-0.399844h-0.99961l-55.478329 0.399844-122.452167 0.799687 34.186646-38.684888c24.390472-27.589223 39.484576-62.9754 42.483405-99.66107l20.292074-250.402187c2.199141-26.589613-7.397111-52.679422-26.289731-71.472081l-10.395939-10.395939m281.889887-64.174932h-0.199922L512.399844 0.599766h-0.799688L348.36392 0h-0.199922c-20.891839 0-39.684498 13.494729-45.582194 33.58688-4.098399 13.994533-1.899258 30.887934 17.79305 47.581414l38.584927 38.584927c5.597813 5.597813 8.39672 13.294807 7.796955 21.091761L346.464662 391.247169c-1.899258 23.190941-11.195627 45.08239-26.589613 62.475596l-61.87583 69.872706c-8.696603 9.796173-13.894572 22.291292-14.394377 35.386177-0.299883 8.996486 1.599375 18.89262 8.596642 27.28934 6.897306 8.296759 17.293245 12.894963 27.989067 12.894963h0.299882l175.931277-1.199532 55.178446 422.834831 0.399844 3.098789 0.399844-3.098789 55.178446-422.834831 175.931277 1.199532h0.299882c10.795783 0 21.191722-4.598204 27.989067-12.894963 6.897306-8.39672 8.796564-18.292854 8.596642-27.28934-0.399844-13.094885-5.697774-25.590004-14.394377-35.386177l-61.87583-69.872706c-15.393987-17.393206-24.690355-39.284654-26.589613-62.475596l-20.292074-250.402187c-0.599766-7.796954 2.199141-15.593909 7.796955-21.091761l38.584927-38.584927c19.692308-16.693479 21.891449-33.58688 17.79305-47.581414-5.997657-19.992191-24.790316-33.58688-45.682155-33.58688z" p-id="6242"></path>
        </svg>
      </button>
      <button id="app-close">
        <img src="../public/close.svg" style="width: 12px;height: 12px"/>
      </button>
    </div>
  </div>
  <div id="app-container">
    <div class="spinner-wrap">
      <div class="spinner">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
    </div>
  </div>
</div>
</body>
<script type="module">
  import {CacheManage} from './CacheManage.js';

  const cacheManage = new CacheManage();
  let senderId = 0;

  document.getElementById('app-top').addEventListener('click', () => {
    utools.sendToParent('handle-ai-tool', {
      event: 'top',
      senderId: senderId
    });
  })
  document.getElementById('app-close').addEventListener('click', () => {
    utools.sendToParent('handle-ai-tool', {
      event: 'close',
      senderId: senderId
    });
  });


  const handleInit = (instance) => {
    (async () => {
      console.log("开始加载", instance)
      if (!instance) {
        return Promise.reject(new Error('缺少参数'));
      }
      const {content, title} = instance;
      senderId = instance.senderId;

      // 修改标题
      document.getElementById('app-title').innerHTML = title;
      // 设置页面title
      document.title = title;

      const res = await cacheManage.handle(content)
      const blob = new Blob([res], {type: 'text/html'})
      const url = URL.createObjectURL(blob);
      // 删除加载中
      document.querySelector('.spinner-wrap').remove();
      // 创建iframe
      const iframe = document.createElement('iframe');
      iframe.frameBorder = '0';
      iframe.classList.add('tool-iframe');
      iframe.src = url;
      document.getElementById('app-container').append(iframe);

    })()
      .then(() => console.log('初始化成功'))
      .catch(e => {
        // 删除加载中元素
        document.querySelector('.spinner-wrap')?.remove();

        // 创建错误显示容器
        const errorContainer = document.createElement('div');
        errorContainer.className = 'error-container';

        // 创建错误标题
        const errorTitle = document.createElement('div');
        errorTitle.className = 'error-title';
        errorTitle.textContent = '加载失败';

        // 创建错误信息
        const errorMessage = document.createElement('div');
        errorMessage.className = 'error-message';
        errorMessage.textContent = e.message || e.toString();

        // 创建错误堆栈信息
        const errorStack = document.createElement('div');
        errorStack.className = 'error-stack';
        errorStack.textContent = e.stack || '无详细堆栈信息';

        // 组装错误显示元素
        errorContainer.appendChild(errorTitle);
        errorContainer.appendChild(errorMessage);
        errorContainer.appendChild(errorStack);

        // 添加到页面
        document.getElementById('app-container').appendChild(errorContainer);
      });
  }

  const handleTop = (top) => {
    const topButton = document.getElementById('app-top');
    if (top) {
      topButton.innerHTML = '';
      const pinnedIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      pinnedIcon.classList.add('icon');
      pinnedIcon.setAttribute('viewBox', '0 0 1024 1024');
      pinnedIcon.setAttribute('version', '1.1');
      pinnedIcon.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
      pinnedIcon.setAttribute('p-id', '6393');
      pinnedIcon.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
      pinnedIcon.setAttribute('width', '64');
      pinnedIcon.setAttribute('height', '64');
      
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', 'M771.798516 586.270988c-6.897306 8.296759-17.293245 12.894963-27.989067 12.894963h-0.299882l-175.931277-1.199532-55.178446 422.834831-0.399844 3.19875-0.399844-3.19875-55.178446-422.834831-175.931277 1.199532h-0.299882c-10.795783 0-21.191722-4.598204-27.989067-12.894963-6.897306-8.39672-8.796564-18.292854-8.596642-27.28934 0.399844-13.094885 5.697774-25.590004 14.394377-35.386177l61.87583-69.872706c15.393987-17.393206 24.790316-39.284654 26.589613-62.475596l20.292074-250.402187c0.599766-7.796954-2.199141-15.593909-7.796955-21.091761l-38.584927-38.584927c-19.692308-16.693479-21.891449-33.58688-17.79305-47.581414 5.897696-20.092152 24.690355-33.58688 45.582194-33.58688h0.199922l163.236236 0.499805h0.799688l163.236236-0.499805h0.199922c20.891839 0 39.684498 13.494729 45.582194 33.58688 4.098399 13.994533 1.899258 30.887934-17.79305 47.581414L664.940258 119.753221c-5.597813 5.597813-8.39672 13.294807-7.796955 21.091761L677.435377 391.247169c1.899258 23.190941 11.195627 45.08239 26.589613 62.475596l61.87583 69.872706c8.696603 9.796173 13.894572 22.291292 14.394377 35.386177 0.299883 8.996486-1.599375 18.89262-8.496681 27.28934z');
      path.setAttribute('p-id', '6394');
      
      pinnedIcon.appendChild(path);
      topButton.appendChild(pinnedIcon);
      topButton.classList.add('top');
    } else {
      topButton.innerHTML = '';
      const pinIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      pinIcon.classList.add('icon');
      pinIcon.setAttribute('viewBox', '0 0 1024 1024');
      pinIcon.setAttribute('version', '1.1');
      pinIcon.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
      pinIcon.setAttribute('p-id', '6241');
      pinIcon.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
      
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', 'M393.846154 64.174932l117.454119 0.399843H512.499805l117.454119-0.399843-10.395939 10.395939c-18.89262 18.89262-28.488872 44.982429-26.28973 71.472081l20.292073 250.502148c2.998829 36.68567 18.092932 72.171808 42.483405 99.661069l34.186646 38.684889-122.252245-0.899648-55.478329-0.399844h-0.99961l-55.478329 0.399844-122.452167 0.799687 34.186646-38.684888c24.390472-27.589223 39.484576-62.9754 42.483405-99.66107l20.292074-250.402187c2.199141-26.589613-7.397111-52.679422-26.289731-71.472081l-10.395939-10.395939m281.889887-64.174932h-0.199922L512.399844 0.599766h-0.799688L348.36392 0h-0.199922c-20.891839 0-39.684498 13.494729-45.582194 33.58688-4.098399 13.994533-1.899258 30.887934 17.79305 47.581414l38.584927 38.584927c5.597813 5.597813 8.39672 13.294807 7.796955 21.091761L346.464662 391.247169c-1.899258 23.190941-11.195627 45.08239-26.589613 62.475596l-61.87583 69.872706c-8.696603 9.796173-13.894572 22.291292-14.394377 35.386177-0.299883 8.996486 1.599375 18.89262 8.596642 27.28934 6.897306 8.296759 17.293245 12.894963 27.989067 12.894963h0.299882l175.931277-1.199532 55.178446 422.834831 0.399844 3.098789 0.399844-3.098789 55.178446-422.834831 175.931277 1.199532h0.299882c10.795783 0 21.191722-4.598204 27.989067-12.894963 6.897306-8.39672 8.796564-18.292854 8.596642-27.28934-0.399844-13.094885-5.697774-25.590004-14.394377-35.386177l-61.87583-69.872706c-15.393987-17.393206-24.690355-39.284654-26.589613-62.475596l-20.292074-250.402187c-0.599766-7.796954 2.199141-15.593909 7.796955-21.091761l38.584927-38.584927c19.692308-16.693479 21.891449-33.58688 17.79305-47.581414-5.997657-19.992191-24.790316-33.58688-45.682155-33.58688z');
      path.setAttribute('p-id', '6242');
      
      pinIcon.appendChild(path);
      topButton.appendChild(pinIcon);
      topButton.classList.remove('top');
    }
  }

  window.preload.ipc.handleFromParent((_e, payload) => {
    const {event, data} = payload;
    if (event === 'init') {
      handleInit(data);
    } else if (event === 'top') {
      handleTop(data.top);
    }
  });

</script>
</html>